<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>天津市机动车排污检控中心监控平台</title>

		<link href="css/css/font-awesome.min.css" rel="stylesheet" type="text/css">
		<link href="css/easyui.css" rel="stylesheet" type="text/css">
		<link rel="stylesheet" href="../css/header.css" />
        <link rel="stylesheet" href="https://js.arcgis.com/3.22/esri/css/esri.css" />
		<style>
			* {
				box-sizing: border-box;
			}
			
			html,
			body {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
				background: #fff;
                overflow:hidden;
			}
			
			* {
				font-family: "微软雅黑";
				font-size: 13px;
				letter-spacing: 1px;
			}
			
			.datagrid-cell {
				overflow: hidden !important;
				text-overflow: ellipsis !important;
				white-space: nowrap !important;
			}
		</style>
        <script src="js/jquery-2.2.1.min.js"></script>
        <script src="js/jquery.easyui.min.js"></script>
        <script type="text/javascript" src="js/column.js"></script>
        <script src="https://js.arcgis.com/3.22/"></script>
	</head>

	<body>
		<div id="tjwq_header">
			<div></div>
		</div>
		<div class="roll" id="roll">
			<a href="javascript:void(0);" class="btn_left"></a>
			<a href="javascript:void(0);" class="btn_right"></a>
			<div class="wrap">
				<ul>
					<li>
						<a href="../index.html" target="">
							<div class="target-button">
								<img src="../images/home.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="jiankongpingtai.html" target="">
							<div class="target-button">
								<img src="../img/1.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="cheliangfenxi.html" target="">
							<div class="target-button">
								<img src="../img/2.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="xincheguanli.html">
							<div class="target-button">
								<img src="../img/3.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="zonghechaxun.html" target="">
							<div class="target-button">
								<img src="../img/4.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="shujufankong.html" target="">
							<div class="target-button">
								<img src="../img/5.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="pingtaijiankong.html" target="">
							<div class="target-button">
								<img src="../img/6.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="tongjifenxi.html" target="">
							<div class="target-button">
								<img src="../img/7.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="zhifajiandu.html" target="">
							<div class="target-button">
								<img src="../img/8.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="shipinzhuisu.html" target="">
							<div class="target-button">
								<img src="../img/9.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="shujuzidian.html" target="">
							<div class="target-button">
								<img src="../img/10.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="baojingjiankong.html" target="">
							<div class="target-button">
								<img src="../img/11.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="xitongguanli.html" target="">
							<div class="target-button">
								<img src="../img/13.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="xitongjiekou.html" target="">
							<div class="target-button">
								<img src="../img/14.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="xinxifabu.html" target="">
							<div class="target-button fr">
								<img src="../img/17.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
					<li>
						<a href="youqifenxi.html" target="">
							<div class="target-button">
								<img src="../img/16.png" width="70px" height="70px" />
							</div>
						</a>
					</li>
				</ul>
			</div>
		</div>
		<div id="nav">
			<span id="tjwqtitlenav" style="margin-left:16px;">欢迎登陆本系统！您当前的位置为：首页</span>
			<div style="float:right;"><span style="margin-right:40px;">您好！天津市用户</span>
				<!--<a href="page-child/resetPwd.html" style="margin-right:16px;">[修改密码]</a>-->
				<a href="../Login.aspx" style="margin-right:16px;">[登出]</a>
			</div>
		</div>
		<div class="pagewrap" style="width:100%;height:100%;margin-top: 30px;padding-left:">
			<div id="tjwqBtn" class="jczjcz left_list">
				<div class="tjwqtitle">
					平台监控
				</div>
				<div class="listbtnz tjwqActive"><b></b>
					<div>GIS平台</div>
				</div>
			</div>
            <div style="width:25%;float:left;">
                <div style="width:100%;height:42px;background:#fff;border-bottom:1px solid #d0d0d0;border-top:1px solid #d0d0d0;">
                    <div style="float:left;margin-left:20px;margin-top:7px;">
                        <input type="text" class="_CUNITNAME" style="width:140px;border:1px solid #d0d0d0;height:27px;" />
                    </div>
                    <div class="page-search" style="margin-top:7px;width:auto;float:left;margin-left:20px;height:27px;padding-left:15px;padding-right:15px;border-radius:4px;background:linear-gradient( to bottom, #458fef , #091CC6 );color:#fff;line-height:27px;">查询</div>
                </div>
                <div style="width:100%;height:100%;background:#f4f4f4;background:#fff;">
                    <div style="width:100%;height:100%;">
                        <table class="page-table"></table>
                    </div>
                </div>
            </div>
            <div style="width:60%;float:left;position:relative;border-left:1px solid #d0d0d0;border-top:1px solid #d0d0d0;padding:10px;background:#fff;">
                <div id="MyMapDiv" style="width:100%;height:100%;   " class="MapClass"></div>
            </div>
        </div>

		
		<script>
            var _tag = 0;   //是否允许插入描点
            var _jianceid = '';
            var str_1 = '';
            var str_2 = '';
            var str_3 = '';
            var str_4 = '';
			$('.page-table').datagrid({
                columns: [[
                        
                        {
                            field: 'CUNITNAME',
                            title: '检测站名称',
                            width: 100,
                            align : 'center'
						},
						{
							field: 'ext',
							align: 'center',
							title: '操作',
                            width: 100,
                            formatter: function (value, row, index) {
                                var _str = '';
                                if (row.CMEMO == null || row.CMEMO == '' || row.CMEMO == '0' ) {
                                    _str = '<a class="checkdis" style="color:#458fef;" onclick="checkdis(' + row.CMEMO + ')">查看详细</a>';
                                } else {
                                    _str = '<a class="checkdis" style="color:#bbb" onclick="checkdis(' + row.CMEMO + ')">查看详细</a>';
                                }
                                return _str;
                            }
						}

				]],
				fitColumns: true,
				striped: true,
				pagination: true,
				rownumbers: true,
				height: $(window).height()-150,
				selectOnCheck: true,
                resizable: true,
                onClickRow: function (rowIndex, rowData) {
                    
                    if (rowData.CMEMO == null || rowData.CMEMO == '' || rowData.CMEMO == '0') {
                        _tag = 1; 
                        _jianceid = rowData.CUNITCODE;
                        str_1 = rowData.CUNITNAME;
                        str_2 = rowData.ISLOCK;
                        str_3 = rowData.CDIRECTOR;
                        str_4 = rowData.CPHONE;

                    } else {
                        _tag = 1;
                        _jianceid = '';
                    }
                },
				loadMsg: '...加载中',
				pageSize: 50,
				pageList: [20, 50, 100, 150],
				singleSelect: true

			});

            $('#MyMapDiv').height($(window).height() - 150);

			function tablerefresh(_pagenumber, _pagesize) {
				$.ajax({
					url: "../../AjaxHandler/AjaxService.ashx",
					data: {
                        method: 'GetMapData',
						pagenumber: _pagenumber,
						pagesize: _pagesize,
                        CUNITNAME: $('._CUNITNAME').val(),
						//CFUELTYPE: $( '.CFUELTYPE' ).val()
					},
					async: false,
					dataType: "json",
					type: "post",
					success: function(json) {
						$('.page-table').datagrid('loadData', json);
					},
					error: function(xhr) {

					}
				});
			}

			tablerefresh(1, 50);

			$('.page-search').click(function() {
				tablerefresh(1, 50);
			});

			$('.page-table').datagrid('getPager').pagination({
				onSelectPage: function(pageNumber, pageSize) {
					tablerefresh(pageNumber, pageSize);
				}
			});
		
            var map, graphicLayer;

            

            //标记数组
            var allMarkers = [];

            function checkdis(x1,x2) {
                if (x1 != undefined && x1 != null) {
                    
                    findMarker(x1 * 1, x2*1);
                }
                
            }

            require([
                "esri/map", "esri/geometry/Circle", "esri/symbols/SimpleFillSymbol",
                "esri/graphic", "esri/layers/GraphicsLayer",
                "dojo/dom", "dojo/dom-attr", "dojo/domReady!"
            ], function (
                Map, Circle, SimpleFillSymbol,
                Grahpic, GraphicsLayer,
                dom, domAttr
            ) {

                    map = new esri.Map("MyMapDiv", {
                        basemap: {
                            baseMapLayers: [{
                                url: "https://services.arcgisonline.com/ArcGIS/rest/services/Specialty/DeLorme_World_Base_Map/MapServer"
                            }],
                            thumbnailUrl: "https://www.example.com/images/thumbnail_2014-11-25_61051.png",
                            title: "Delorme"
                        },
                        zoom: 10,
                        center: [117.20, 39.12]
                    });

                    var MyTiledMapServiceLayer = new esri.layers.ArcGISDynamicMapServiceLayer("http://172.16.1.14:6080/arcgis/rest/services/jjj_city/MapServer?token=FLqIUkgf63DnQgw-kEImT4YY4RD8TCImmTwULWo8mS1WBbovqZ-JULJ899yXOWVy");
                    map.addLayer(MyTiledMapServiceLayer);
                    //创建图层
                    graphicLayer = new GraphicsLayer();
                    //把图层添加到地图上
                    map.addLayer(graphicLayer);



                    map.on("click", function (e) {
                        if ( _tag != 1 ) {
                            return;
                        }

                        addMarker(e.mapPoint.x, e.mapPoint.y);
                        //addMarker(13051551.574455077, 4754315.428059879);
                        _tag = 0;
                    });
                    
                    map.showZoomSlider();
                    
                    
                });
            function findMarker(xx, yy) {
                var pt = new esri.geometry.Point(xx, yy, map.spatialReference);
                var symbol1 = new esri.symbol.PictureMarkerSymbol("../img/icon.png", 25, 25);
                var attr = { "address": "测试" };
                var infoTemplate = new esri.InfoTemplate("标题", "地址:${address}");
                var graphic = new esri.Graphic(pt, symbol1, attr, infoTemplate);
                graphicLayer.add(graphic);
                setMapCenter(xx, yy, 10);
            }
            function addMarker(xx, yy) {

                //设置标注的经纬度
                //方法一
                var pt = new esri.geometry.Point(xx, yy, map.spatialReference);
                //方法二
                //  var pt = new esri.geometry.geographicToWebMercator(new esri.geometry.Point({
                //    "x": 118.0605760000,
                //    "y": 36.8424320000,
                //    "spatialReference": { "wkid": 102113 }
                //            }));

                //设置标注显示的图标
                //var symbol = new esri.symbol.SimpleMarkerSymbol();
                var symbol1;
                if (str_2 == '1') {
                    symbol1 = new esri.symbol.PictureMarkerSymbol("../img/icon2.png", 25, 25);
                } else {
                    symbol1 = new esri.symbol.PictureMarkerSymbol("../img/icon.png", 25, 25);
                }
                

                //要在模版中显示的参数
                var attr = { "": "" };

                //创建模版
                var infoTemplate = new esri.InfoTemplate("信息详情", "<div><ul><li>名称：" + str_1 + "</li><li>状态：" + (str_2=='1'?'断开':'正常') + "</li><li>负责人：" + str_3 + "</li><li>联系电话：" + str_4 + "</li></ul></div>");
                //创建图像
                var graphic = new esri.Graphic(pt, symbol1, attr, infoTemplate);
                //把图像添加到刚才创建的图层上
                graphicLayer.add(graphic);
                setMapCenter(xx, yy, 10);
                
                $.ajax({
                    url: "../../AjaxHandler/AjaxService.ashx",
                    data: {
                        method: 'UpdateMapData',
                        CUNITCODE: _jianceid,
                        CMEMO : xx + ',' + yy
                    },
                    async: false,
                    dataType: "json",
                    type: "post",
                    success: function (json) {
                        tablerefresh(1, 50);
                    },
                    error: function (xhr) {

                    }
                });


            }


            function addMarkers(xx, yy,obj) {

                //设置标注的经纬度
                //方法一
                var pt = new esri.geometry.Point(xx, yy, map.spatialReference);
                //方法二
                //  var pt = new esri.geometry.geographicToWebMercator(new esri.geometry.Point({
                //    "x": 118.0605760000,
                //    "y": 36.8424320000,
                //    "spatialReference": { "wkid": 102113 }
                //            }));

                //设置标注显示的图标
                //var symbol = new esri.symbol.SimpleMarkerSymbol();
                var symbol1;
                if (obj.ISLOCK == 1) {
                    symbol1 = new esri.symbol.PictureMarkerSymbol("../img/icon2.png", 25, 25);
                } else {
                    symbol1 = new esri.symbol.PictureMarkerSymbol("../img/icon.png", 25, 25);
                }

                //要在模版中显示的参数
                var attr = { "address": "测试" };

                //创建模版
                var infoTemplate = new esri.InfoTemplate("信息详情", "<div><ul><li>名称：" + obj.CUNITNAME + "</li><li>状态：" + (obj.ISLOCK == 1 ? '断开' : '正常') + "</li><li>负责人：" + obj.CDIRECTOR + "</li><li>联系电话：" + obj.CPHONE + "</li></ul></div>");
                //创建图像
                var graphic = new esri.Graphic(pt, symbol1, attr, infoTemplate);
                //把图像添加到刚才创建的图层上
                graphicLayer.add(graphic);
                setMapCenter(xx, yy, 10);
                
            }

            function setMapCenter(xx, yy, level) {
                var point = new esri.geometry.Point(xx, yy, map.spatialReference);
                map.centerAndZoom(point, level);
            }

            //添加标注
            function mapAddOverLay(xx, yy, id, labelname) {
                var point = new BMap.Point(xx, yy);
                var marker = new BMap.Marker(point);
                map.addOverlay(marker); //添加标注

                allMarkers.push(marker); //记录覆盖物句柄

                if (labelname != "") {
                    var label = new BMap.Label(labelname, { offset: new BMap.Size(20, -10) });
                    marker.setLabel(label); //添加Label
                }

                //添加标注回调
                addOverlayCallback(marker, xx, yy, id);
            }

            setTimeout(function () {
                $.ajax({
                    url: "../../AjaxHandler/AjaxService.ashx",
                    data: {
                        method: 'GetMapData',
                        pagenumber: '',
                        pagesize: '',
                        CUNITNAME: ''
                    },
                    async: false,
                    dataType: "json",
                    type: "post",
                    success: function (json) {
                        for (var c = 0; c < json.length; c++) {
                            var xx = json[c].CMEMO.split(',');
                            addMarkers(xx[0] * 1, xx[1] * 1,json[ c ]);
                        }
                    },
                    error: function (xhr) {

                    }
                });

            }, 2000);
            
        </script>
	</body>

</html>